<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시험채점 - 이젠에듀원격평생교육원</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Scoped CSS -->
    <link rel="stylesheet" href="layout.css">
    <link rel="stylesheet" href="css/exam_grading.css">
</head>

<body>

    <div class="prof-exam-split-container">

        <!-- Left Panel: Student List -->
        <div class="prof-exam-left-panel">
            <div class="prof-exam-list-header">
                <input type="text" class="prof-exam-search" placeholder="이름 또는 아이디 검색">
                <!-- Privacy Toggle Small -->
                <label class="security-mask-toggle" title="개인정보 보호 모드" style="font-size: 0.8rem; margin:10px auto;">
                    <input type="checkbox" class="toggle-switch-input" id="privacyToggle" checked
                        onchange="toggleMasking(this)">
                    <div class="toggle-switch-label" style="width:30px; height:16px;"></div>
                    <span>개인정보보호 ON</span>
                </label>
                <select class="prof-exam-sort">
                    <option>채점 대기순</option>
                    <option>아이디순</option>
                    <option>점수순</option>
                </select>
            </div>
            <ul class="prof-exam-student-list">
                <li class="prof-exam-student-item active">
                    <span class="prof-exam-student-name">
                        <span class="privacy-name" data-original="김이젠">김이젠</span>
                        (<span class="privacy-id" data-original="2024005">2024005</span>)
                    </span>
                    <div class="prof-exam-student-meta">
                        <span>현재 40점</span>
                        <span class="prof-exam-badge prof-exam-badge-waiting">채점대기</span>
                    </div>
                </li>
                <li class="prof-exam-student-item">
                    <span class="prof-exam-student-name">
                        <span class="privacy-name" data-original="박철수">박철수</span>
                        (<span class="privacy-id" data-original="2024003">2024003</span>)
                    </span>
                    <div class="prof-exam-student-meta">
                        <span>현재 38점</span>
                        <span class="prof-exam-badge prof-exam-badge-waiting">채점대기</span>
                    </div>
                </li>
                <li class="prof-exam-student-item" style="background-color: #f9f9f9;">
                    <span class="prof-exam-student-name">
                        <span class="privacy-name" data-original="홍길동">홍길동</span>
                        (<span class="privacy-id" data-original="2024001">2024001</span>)
                    </span>
                    <div class="prof-exam-student-meta">
                        <span>총점 95점</span>
                        <span class="prof-exam-badge prof-exam-badge-done">채점완료</span>
                    </div>
                </li>
                <!-- More items... -->
            </ul>
        </div>

        <!-- Right Panel: Grading Area -->
        <div class="prof-exam-right-panel">
            <div class="prof-exam-grading-header">
                <div>
                    <strong style="font-size: 1.1rem;">
                        <span class="privacy-name" data-original="김이젠">김이젠</span>
                        (<span class="privacy-id" data-original="2024005">2024005</span>)
                    </strong>
                    <span style="color: #666; margin-left: 10px;">경영학부</span>
                </div>
                <div>
                    <span style="font-size: 0.9rem; color: #666;">현재 총점:</span>
                    <strong style="font-size: 1.2rem; color: #0056b3;">40</strong>
                    <span style="font-size: 0.9rem; color: #999;">/ 100</span>
                </div>
            </div>

            <div class="prof-exam-grading-content">

                <!-- Objective Summary -->
                <div class="prof-exam-objective-summary">
                    <div class="prof-exam-summary-header" onclick="toggleSummary()">
                        <span><i class="fa-solid fa-list-check"></i> 객관식 20문항 결과</span>
                        <span>40 / 40점 <span class="prof-exam-badge prof-exam-badge-auto"
                                style="margin-left: 10px;">자동채점 완료 ✅</span></span>
                    </div>
                    <div class="prof-exam-summary-body" id="objectiveSummary">
                        <p>상세 채점 내역이 여기에 표시됩니다. (문항별 O/X)</p>
                    </div>
                </div>

                <!-- Subjective Question 1 -->
                <div class="prof-exam-question-card">
                    <div class="prof-exam-question-title">Q21. SWOT 분석의 4가지 요소를 서술하시오. (5점)</div>
                    <div class="prof-exam-model-answer">
                        <strong><i class="fa-regular fa-lightbulb"></i> 모범 답안:</strong><br>
                        Strength(강점), Weakness(약점), Opportunity(기회), Threat(위협)
                    </div>
                    <div class="prof-exam-student-answer">
                        <strong>학생 답안:</strong><br>
                        강점, 약점, 기회, 위기입니다.
                    </div>
                    <div class="prof-exam-scoring-area">
                        <label>점수:</label>
                        <input type="number" class="prof-exam-score-input" value="5" max="5" min="0"
                            onchange="calculateTotalScore()">
                        <span style="color: #666;">/ 5</span>
                        <div style="margin-left: 10px;">
                            <button class="prof-exam-score-btn" onclick="setScore(this, 5)">만점</button>
                            <button class="prof-exam-score-btn" onclick="setScore(this, 3)">3점</button>
                            <button class="prof-exam-score-btn" onclick="setScore(this, 0)">0점</button>
                        </div>
                        <input type="text" class="prof-exam-comment-input" placeholder="코멘트 (선택사항)">
                    </div>
                </div>

                <!-- Subjective Question 2 -->
                <div class="prof-exam-question-card">
                    <div class="prof-exam-question-title">Q22. 마케팅 믹스(4P)에 대해 설명하시오. (5점)</div>
                    <div class="prof-exam-model-answer">
                        <strong><i class="fa-regular fa-lightbulb"></i> 모범 답안:</strong><br>
                        Product(제품), Price(가격), Place(유통), Promotion(촉진)
                    </div>
                    <div class="prof-exam-student-answer">
                        <strong>학생 답안:</strong><br>
                        Product, Price 까지는 알겠는데 나머지는 모르겠습니다.
                    </div>
                    <div class="prof-exam-scoring-area">
                        <label>점수:</label>
                        <input type="number" class="prof-exam-score-input" value="2" max="5" min="0"
                            onchange="calculateTotalScore()">
                        <span style="color: #666;">/ 5</span>
                        <div style="margin-left: 10px;">
                            <button class="prof-exam-score-btn" onclick="setScore(this, 5)">만점</button>
                            <button class="prof-exam-score-btn" onclick="setScore(this, 3)">3점</button>
                            <button class="prof-exam-score-btn" onclick="setScore(this, 0)">0점</button>
                        </div>
                        <input type="text" class="prof-exam-comment-input" placeholder="코멘트 (선택사항)">
                    </div>
                </div>

                <!-- Subjective Question 3 -->
                <div class="prof-exam-question-card">
                    <div class="prof-exam-question-title">Q23. STP 전략의 3단계를 순서대로 서술하시오. (5점)</div>
                    <div class="prof-exam-model-answer">
                        <strong><i class="fa-regular fa-lightbulb"></i> 모범 답안:</strong><br>
                        Segmentation(시장세분화), Targeting(목표시장선정), Positioning(포지셔닝)
                    </div>
                    <div class="prof-exam-student-answer">
                        <strong>학생 답안:</strong><br>
                        세분화하고 타겟 정하고 위치 선정하는 것 같습니다.
                    </div>
                    <div class="prof-exam-scoring-area">
                        <label>점수:</label>
                        <input type="number" class="prof-exam-score-input" value="4" max="5" min="0"
                            onchange="calculateTotalScore()">
                        <span style="color: #666;">/ 5</span>
                        <div style="margin-left: 10px;">
                            <button class="prof-exam-score-btn" onclick="setScore(this, 5)">만점</button>
                            <button class="prof-exam-score-btn" onclick="setScore(this, 3)">3점</button>
                            <button class="prof-exam-score-btn" onclick="setScore(this, 0)">0점</button>
                        </div>
                        <input type="text" class="prof-exam-comment-input" placeholder="코멘트 (선택사항)">
                    </div>
                </div>

                <!-- Subjective Question 4 -->
                <div class="prof-exam-question-card">
                    <div class="prof-exam-question-title">Q24. 제품 수명 주기(PLC)의 4단계를 서술하시오. (5점)</div>
                    <div class="prof-exam-model-answer">
                        <strong><i class="fa-regular fa-lightbulb"></i> 모범 답안:</strong><br>
                        도입기, 성장기, 성숙기, 쇠퇴기
                    </div>
                    <div class="prof-exam-student-answer">
                        <strong>학생 답안:</strong><br>
                        도입기, 성장기, 쇠퇴기... 하나는 기억이 안납니다.
                    </div>
                    <div class="prof-exam-scoring-area">
                        <label>점수:</label>
                        <input type="number" class="prof-exam-score-input" value="3" max="5" min="0"
                            onchange="calculateTotalScore()">
                        <span style="color: #666;">/ 5</span>
                        <div style="margin-left: 10px;">
                            <button class="prof-exam-score-btn" onclick="setScore(this, 5)">만점</button>
                            <button class="prof-exam-score-btn" onclick="setScore(this, 3)">3점</button>
                            <button class="prof-exam-score-btn" onclick="setScore(this, 0)">0점</button>
                        </div>
                        <input type="text" class="prof-exam-comment-input" placeholder="코멘트 (선택사항)">
                    </div>
                </div>

                <!-- Subjective Question 5 -->
                <div class="prof-exam-question-card">
                    <div class="prof-exam-question-title">Q25. 4차 산업혁명의 핵심 기술 3가지를 나열하시오. (5점)</div>
                    <div class="prof-exam-model-answer">
                        <strong><i class="fa-regular fa-lightbulb"></i> 모범 답안:</strong><br>
                        인공지능(AI), 사물인터넷(IoT), 빅데이터, 클라우드 컴퓨팅 등
                    </div>
                    <div class="prof-exam-student-answer">
                        <strong>학생 답안:</strong><br>
                        AI, 빅데이터
                    </div>
                    <div class="prof-exam-scoring-area">
                        <label>점수:</label>
                        <input type="number" class="prof-exam-score-input" value="3" max="5" min="0"
                            onchange="calculateTotalScore()">
                        <span style="color: #666;">/ 5</span>
                        <div style="margin-left: 10px;">
                            <button class="prof-exam-score-btn" onclick="setScore(this, 5)">만점</button>
                            <button class="prof-exam-score-btn" onclick="setScore(this, 3)">3점</button>
                            <button class="prof-exam-score-btn" onclick="setScore(this, 0)">0점</button>
                        </div>
                        <input type="text" class="prof-exam-comment-input" placeholder="코멘트 (선택사항)">
                    </div>
                </div>

                <div style="height: 100px;"></div> <!-- Spacer for FAB -->

            </div>
        </div>

    </div>

    <!-- Floating Action Button -->
    <button class="prof-exam-fab" onclick="saveAndNext()">
        <i class="fa-solid fa-check"></i> 채점 저장 및 다음 학생
    </button>

    <!-- Integrated Grading Workspace Overlay -->
    <div id="gradingWorkspaceOverlay">
        <button class="gw-close-btn" onclick="closeWorkspace()">
            <i class="fa-solid fa-xmark"></i>
        </button>

        <div class="gw-container">
            <!-- Col 1: Navigation -->
            <div class="gw-col-nav">
                <div class="gw-mode-tabs">
                    <div class="gw-tab active" onclick="setMode('student')">학생별</div>
                    <div class="gw-tab" onclick="setMode('question')">문항별</div>
                </div>
                <!-- Dynamic List -->
                <ul class="gw-nav-list" id="gwNavList">
                    <!-- populated by JS -->
                </ul>
            </div>

            <!-- Col 2: Sub-List -->
            <div class="gw-col-sub">
                <div class="gw-sub-header" id="gwSubHeader">문항 목록</div>
                <ul class="gw-sub-list" id="gwSubList">
                    <!-- populated by JS -->
                </ul>
            </div>

            <!-- Col 3: Workspace -->
            <div class="gw-col-main" id="gwMainArea">
                <!-- Content injected by JS -->
                <div style="display:flex; justify-content:center; align-items:center; height:100%; color:#999;">
                    <p>좌측에서 항목을 선택해주세요.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="layout.js"></script>
    <script>
        initLayout('exam_grading');

        // ==========================================
        // Data & State
        // ==========================================
        const STUDENTS = [
            { id: '2024005', name: '김이젠', score: 40, status: 'waiting' },
            { id: '2024003', name: '박철수', score: 38, status: 'waiting' },
            { id: '2024001', name: '홍길동', score: 95, status: 'done' },
            { id: '2024008', name: '최영희', score: 88, status: 'done' },
            { id: '2024012', name: '이민수', score: 0, status: 'waiting' }
        ];

        const QUESTIONS = [
            { id: 'Q21', score: 5, type: 'subjective', title: 'SWOT 분석의 4가지 요소를 서술하시오.', model: 'Strength(강점), Weakness(약점), Opportunity(기회), Threat(위협)', answer: '강점, 약점, 기회, 위기입니다.' },
            { id: 'Q22', score: 5, type: 'subjective', title: '마케팅 믹스(4P)에 대해 설명하시오.', model: 'Product(제품), Price(가격), Place(유통), Promotion(촉진)', answer: 'Product, Price 까지는 알겠는데 나머지는 모르겠습니다.' },
            { id: 'Q23', score: 5, type: 'subjective', title: 'ESG 경영의 3가지 핵심 요소는 무엇인가?', model: 'Environment(환경), Social(사회), Governance(지배구조)', answer: '환경이랑 사회 공헌, 그리고 주주 가치 제고라고 알고 있습니다.' },
            { id: 'Q24', score: 10, type: 'subjective', title: '깨진 유리창의 법칙이 조직 관리에서 주는 시사점', model: '사소한 무질서나 문제를 방치하면 나중에 큰 범죄나 조직의 붕괴로 이어질 수 있다는 이론.', answer: '작은 실수를 용납하지 않는 엄격한 규율이 필요하다는 뜻입니다.' },
            { id: 'Q25', score: 5, type: 'subjective', title: '손익분기점(BEP)의 정의를 서술하시오.', model: '총수익과 총비용이 일치하여 이익도 손실도 발생하지 않는 시점(매출액).', answer: '회사가 돈을 벌기 시작하는 시점.' }
        ];

        let currentMode = 'student'; // 'student' or 'question'
        let currentNavIndex = 0; // Index in main list (Student or Question)
        let currentSubIndex = 0; // Index in sub list (Question or Student)

        // ==========================================
        // Initialization & Events
        // ==========================================
        window.addEventListener('DOMContentLoaded', () => {
            const toggle = document.getElementById('privacyToggle');
            if (toggle) toggleMasking(toggle);

            // Attach click event to existing students to open overlay
            document.querySelectorAll('.prof-exam-student-item').forEach((item, index) => {
                item.onclick = () => {
                    openWorkspace(index);
                };
            });
        });

        function toggleSummary() {
            document.getElementById('objectiveSummary').classList.toggle('active');
        }

        // Existing page logic (Total Score) - retained for background compatibility
        function calculateTotalScore() { /* ... */ }

        // ==========================================
        // Workspace Overlay Logic
        // ==========================================

        function openWorkspace(studentIndex = 0) {
            document.getElementById('gradingWorkspaceOverlay').classList.add('active');
            currentMode = 'student';
            currentNavIndex = studentIndex;
            currentSubIndex = 0; // Start with first question
            renderNavList();
            renderSubList();
            renderMainArea();
        }

        function closeWorkspace() {
            document.getElementById('gradingWorkspaceOverlay').classList.remove('active');
        }

        function setMode(mode) {
            currentMode = mode;
            // Update tabs UI
            const tabs = document.querySelectorAll('.gw-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Reset indices
            currentNavIndex = 0;
            currentSubIndex = 0;

            renderNavList();
            renderSubList();
            renderMainArea();
        }

        function renderNavList() {
            const listEl = document.getElementById('gwNavList');
            listEl.innerHTML = '';

            const data = currentMode === 'student' ? STUDENTS : QUESTIONS;

            data.forEach((item, idx) => {
                const li = document.createElement('li');
                li.className = `gw-nav-item ${idx === currentNavIndex ? 'active' : ''}`;
                // Label depends on mode
                let label = '';
                if (currentMode === 'student') {
                    label = `<span class="privacy-name" data-original="${item.name}">${item.name}</span>`;
                } else { // question
                    label = `${item.id} (5점)`; // fixed score for demo label simplification 
                }

                li.innerHTML = label;
                li.onclick = () => {
                    currentNavIndex = idx;
                    currentSubIndex = 0; // Reset sub selection
                    renderNavList(); // Re-render to update active
                    renderSubList();
                    renderMainArea();
                };
                listEl.appendChild(li);
            });

            // Re-apply masking if needed
            const toggle = document.getElementById('privacyToggle');
            if (toggle && toggle.checked) toggleMasking(toggle);
        }

        function renderSubList() {
            const listEl = document.getElementById('gwSubList');
            const headerEl = document.getElementById('gwSubHeader');
            listEl.innerHTML = '';

            let data = [];

            if (currentMode === 'student') {
                headerEl.innerText = '문항 목록';
                // Show Questions for selected student
                data = QUESTIONS;
            } else {
                headerEl.innerText = '학생 목록';
                // Show Students for selected question
                data = STUDENTS;
            }

            data.forEach((item, idx) => {
                const li = document.createElement('li');
                li.className = `gw-sub-item ${idx === currentSubIndex ? 'active' : ''}`;

                let left = '';
                let right = ''; // status or score

                if (currentMode === 'student') {
                    // Item is Question
                    left = item.id;
                    // In a real app we would look up this student's specific score for this question
                    right = item.id === 'Q21' ? '<span style="color:#2e7d32">5점</span>' : '<span style="color:#ccc">-</span>';
                } else {
                    // Item is Student
                    left = `<span class="privacy-name" data-original="${item.name}">${item.name}</span>`;
                    right = '<span style="color:#ccc">-</span>';
                }

                li.innerHTML = `<span>${left}</span> ${right}`;
                li.onclick = () => {
                    currentSubIndex = idx;
                    renderSubList(); // update active
                    renderMainArea();
                };
                listEl.appendChild(li);
            });

            // Re-apply masking
            const toggle = document.getElementById('privacyToggle');
            if (toggle && toggle.checked) toggleMasking(toggle);
        }

        function renderMainArea() {
            const container = document.getElementById('gwMainArea');
            container.innerHTML = '';

            // Determine what to show
            let question, studentName, studentAnswer, maxScore;

            if (currentMode === 'student') {
                const student = STUDENTS[currentNavIndex];
                question = QUESTIONS[currentSubIndex];
                studentName = student.name;
                // Specific answer mapping (Mock)
                studentAnswer = (question.id === 'Q21') ? '강점, 약점, 기회, 위기입니다.' : question.answer;
                maxScore = question.score;
            } else {
                question = QUESTIONS[currentNavIndex];
                const student = STUDENTS[currentSubIndex];
                studentName = student.name;
                studentAnswer = (question.id === 'Q21') ? '강점, 약점, 기회, 위기입니다.' : student.answer; // Just reusing dummy
                maxScore = question.score;
            }

            // HTML Construction
            const html = `
                <div class="gw-question-area">
                    <div class="gw-q-title">${question.id}. ${question.title} (${maxScore}점)</div>
                    
                    <div class="gw-model-answer" onclick="this.classList.toggle('open')">
                        <div style="display:flex; justify-content:space-between;">
                            <strong><i class="fa-regular fa-lightbulb"></i> 모범 답안 (Click to toggle)</strong>
                            <i class="fa-solid fa-chevron-down"></i>
                        </div>
                        <div class="gw-model-answer-content">
                            ${question.model}
                        </div>
                    </div>

                    <div style="font-weight:bold; margin-bottom:10px;">
                        <span class="privacy-name" data-original="${studentName}">${studentName}</span> 학생의 답안
                    </div>
                    <div class="gw-student-answer">
                        ${studentAnswer}
                    </div>
                </div>

                <div class="gw-input-area">
                    <div style="flex-grow:0;">
                        <label style="display:block; font-size:0.8rem; margin-bottom:5px; font-weight:bold;">점수</label>
                        <input type="number" class="gw-score-input" id="gwScoreInput" max="${maxScore}" min="0">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="gw-quick-btn" onclick="setGwScore(${maxScore})">만점</button>
                        <button class="gw-quick-btn" onclick="setGwScore(0)">0점</button>
                    </div>
                     <div class="gw-guide-text">
                        <i class="fa-solid fa-arrow-turn-down-left"></i> Enter: 저장 & 다음
                    </div>
                </div>
            `;

            container.innerHTML = html;

            // Focus Input
            const input = document.getElementById('gwScoreInput');
            input.focus();

            // Re-apply masking
            const toggle = document.getElementById('privacyToggle');
            if (toggle && toggle.checked) toggleMasking(toggle);

            // Add Enter Key Listener for this input
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    // Save action
                    // Move to next Sub Item
                    if (currentSubIndex < (currentMode === 'student' ? QUESTIONS.length : STUDENTS.length) - 1) {
                        currentSubIndex++;
                        renderSubList();
                        renderMainArea();
                    } else {
                        // End of sub list, maybe move to next main?
                        alert('마지막 항목입니다. 저장되었습니다.');
                    }
                }
            });
        }

        function setGwScore(val) {
            const inp = document.getElementById('gwScoreInput');
            if (inp) {
                inp.value = val;
                inp.focus();
            }
        }

    </script>
</body>

</html>